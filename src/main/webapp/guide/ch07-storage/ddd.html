<!DOCTYPE html>

<head>
<meta charset="utf-8"/>
<title>自测ddd</title>
<script>
var dt = null;
var db = openDatabase("webdb", "", "test db", 102400);

function init(){
	dt = document.getElementById("datatable");	
	showAllData();
}
function showAllData(){
	db.transaction(function(tx){
		var sql = "create table if not exists MsgData(name text, message text, time integer)";
		tx.executeSql(sql, []);
		
		sql = "select * from MsgData";
		tx.executeSql(sql, [], function(tx, rs){
			removeAllData();
			for(var i=0;i<rs.rows.length; i++){
				showData(rs.rows.item(i));
			}
		});
	});
}
function removeAllData(){
	for(var i=dt.childNodes.length-1; i>=0; i--){
		dt.removeChild(dt.childNodes[i]);
	}
    var tr = document.createElement('tr');  
    var th1 = document.createElement('th');  
    var th2 = document.createElement('th');  
    var th3 = document.createElement('th');  
    th1.innerHTML = '姓名';  
    th2.innerHTML = '留言';  
    th3.innerHTML = '时间';  
    tr.appendChild(th1);  
    tr.appendChild(th2);  
    tr.appendChild(th3);  
    dt.appendChild(tr);
}
function showData(row){
	var tr = document.createElement('tr');  
    var td1 = document.createElement('td');  
    td1.innerHTML = row.name;  
    var td2 = document.createElement('td');  
    td2.innerHTML = row.message;  
    var td3 = document.createElement('td');  
    var t = new Date();  
    t.setTime(row.time);  
    td3.innerHTML=t.toLocaleDateString()+" "+t.toLocaleTimeString();  
    tr.appendChild(td1);  
    tr.appendChild(td2);  
    tr.appendChild(td3);  
    dt.appendChild(tr);
}
function saveData(){
	var name = document.getElementById('name').value;  
    var memo = document.getElementById('memo').value;  
    var time = new Date().getTime();  
    addData(name,memo,time);  
    showAllData();  
}
function addData(name, message, time){
	db.transaction(function(tx){
		var sql = "insert into MsgData values(?, ?, ?)";
		tx.executeSql(sql, [name, message, time], function(tx,rs){
			console.log("保存成功！");
		}, function(tx,err){
			console.log(err.source + ":" + err.message);
		});
	});
}
</script>
</head>

<body onload="init();">  
<h1>使用数据库实现Web留言本</h1>  
<table>  
    <tr><td>姓名:</td><td><input type="text" id="name"></td></tr>  
    <tr><td>留言:</td><td><input type="text" id="memo"></td></tr>  
    <tr>
<td></td>
<td><input type="button" value="保存" onclick="saveData();"></td>
</tr>  
</table>  
<hr>  
<table id="datatable" border="1"></table>  
<p id="msg"></p>  
</body>  
</html>