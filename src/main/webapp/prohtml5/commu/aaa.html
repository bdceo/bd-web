<!DOCTYPE html>
<head>
<meta charset="utf-8"/> 
<title>自测aaa Portal[http://portal.example.com:9999]</title>
<link rel="stylesheet" href="styles.css"/>
<style>
	iframe{
		height:400px;
		width:800px;
	}
</style>
<link rel="icon" href="http://apress.com/favicon.ico"/>
<script>
function checkSupport(){
	if(typeof window.postMessage !== undefined){
		document.getElementById("support").innerHTML="恭喜，浏览器支持！";
	}else{
		document.getElementById("support").innerHTML="老兄，升级一下浏览器吧！";
	}
}

var defaultTitle = "自测aaa Portal[http://portal.example.com:8080]";
var notificationTimer = null;
var targetOrigin = "http://chat.example.net:8080";
 
function messageHandler(e){
	if(e.origin == targetOrigin){
		notify(e.data);
	}else{
		// 不可信源，不处理
		console.log("不可信源，不处理");
	}
}

function sendString(s){
	document.getElementById("widget").contentWindow.postMessage(s, targetOrigin);
}

function notify(message){
	stopBinking();
	binkTitle(message, defaultTitle);	
}

function stopBinking(){
	if(notificationTimer !== null){
		clearTimeout(notificationTimer);
	}
	document.title = defaultTitle;
}

function binkTitle(m1, m2){
	document.title = m1;
	notificationTimer = setTimeout(blinkTitle, 1000, m2, m1);
}

function sendStatus(){
	var statusText = document.getElementById("statusText").value;
	sendString(statusText);
}

function loadDemo(){
	document.getElementById("sendButton").addEventListener("click", sendStatus, true);
	document.getElementById("stopButton").addEventListener("click", stopBinkling, true);
	sendStatus();
}

window.addEventListener("load", loadDemo, true);
window.addEventListener("message", messageHandler, true);
</script>
</head>

<body onLoad="checkSupport()">
<div id="support"></div>
<h1>跨源通信</h1>
<p><b>源</b>：http://portal.exemple.com:9999</p>
状态 <input type="text" id="statusText" value="Online"/>
<button id="sendButton">状态改变</button>
<p>使用postMessage发送状态信息到iframe组件</p>
<iframe id="widget" src="http://chat:example.net:9999/bbb.html"/>
<p><button id="stopButton">停止闪烁</button></p>
</body>
</html>
